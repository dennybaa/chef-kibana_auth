# Generated by Chef
server {
  listen                <%= @listen_address %>:<%= @listen_port %>;

  server_name           <%= @server_name %> <%= @server_aliases.join(" ") %>;
  access_log            <%= node['nginx']['log_dir'] %>/<%= @server_name %>.access.log;

  proxy_connect_timeout 2s;

  # Proxy all requests to Kibana3 Auth proxy
  location / {
    proxy_pass http://<%= node['kibana']['auth']['bind'] %>:<%= node['kibana']['auth']['port'] %>;
  }

  # Proxied locations needed for Kibana
  # requests are directed to ES
  location ~ ^/_aliases$ {
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
  location ~ ^/.*/_aliases$ {
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
  location ~ ^/_nodes$ {
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
<% if node['kibana']['auth']['private_dashboards'] -%>
  location ~  ^/(?!kibana-int).*/_search$ {
<% else -%>
  location ~  ^/.*/_search$ {
<% end -%>
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
  location ~ ^/.*/_mapping$ {
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
<% unless node['kibana']['auth']['private_dashboards'] -%>

  location ~ ^/kibana-int/dashboard/.*$ {
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
  location ~ ^/kibana-int/temp.*$ {
    proxy_pass <%= @es_scheme %><%= @es_server %>:<%= @es_port %>;
    proxy_read_timeout 90;
    auth_basic "Restricted";
    auth_basic_user_file <%= node['kibana']['auth']['file_path'] %>;
  }
<% end -%>
}
